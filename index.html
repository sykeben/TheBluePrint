<!DOCTYPE html>

<html lang="en">

    <head>

        <!-- Meta -->
        <meta charset="utf-8">
        <title>TheBluePrint</title>

        <!-- Vendor -->
        <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css">

    </head>

    <body class="m-0">

        <!-- Navbar (Does not print) -->
        <div class="navbar navbar-expand navbar-dark bg-primary d-print-none">

            <!-- Brand -->
            <div class="navbar-brand">TheBluePrint</div>

            <!-- Team Number Input -->
            <div class="collapse navbar-collapse">

                <!-- Dummy Nav -->
                <ul class="navbar-nav mr-auto"></ul>

                <!-- Form -->
                <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2 text-primary border-white" type="search" autocomplete="off" placeholder="Team Number" id="team-input" name="team">
                    <input class="form-control mr-sm-2 text-primary border-white" type="search" autocomplete="off" placeholder="Event Key" id="event-input" name="event">
                    <button class="btn text-primary btn-light my-2 my-sm-0" type="submit">Search</button>
                </form>

            </div>

        </div>

        <!-- Info Container -->
        <div class="container p-5">

            <!-- Header (Replaces navbar in printing) -->
            <div class="p-2 m-0 d-none d-print-block">
                <h1>TheBluePrint</h1>
                <p>
                    <span id="event-name"></span>,
                    <span id="event-city"></span>,
                    <span id="event-state"></span>
                    (<span id="event-start"></span> to <span id="event-end"></span>)
                </p>
            </div>

            <!-- Match List -->
            <table class="table table-striped table-hover border">

                <!-- Header -->
                <thead>
                    <tr>
                        <th scope="col" class="border-right">Match</th>
                        <th scope="col" class="border-right">Time</th>
                        <th scope="col" colspan="3" class="border-right">Red Alliance</th>
                        <th scope="col" colspan="3">Blue Alliance</th>
                    </tr>
                </thead>

                <!-- Body -->
                <tbody id="match-list"></tbody>

            </table>

        </div>

        <!-- Vendor -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/popper/popper.min.js"></script>
        <script src="vendor/bootstrap/bootstrap.min.js"></script>

        <!-- Interface Script -->
        <script>

            // Team formatting function.
            function formatTeam(key) {
                if (key == undefined || key == null || key == '') key = 'frcN/A';
                key = key.replace('frc', '');
                if (key == teamNumber) return `<strong>${key}</strong>`;
                else return key;
            }

            // Match item generator.
            function generateMatchItems(input) {
                let out = "";
                for (let i=0; i<input.length; i++) {
                    if (input[i] != undefined) {
                        out += `<tr>`+
                            `<th scope="col" class="border-right">${input[i].comp_level.toUpperCase()} ${input[i].match_number}</th>`+
                            `<td class="border-right">${new Date(input[i].time*1000).toLocaleTimeString()}</td>`+
                            `<td>${formatTeam(input[i].alliances.red.team_keys[0])}</td>`+
                            `<td>${formatTeam(input[i].alliances.red.team_keys[1])}</td>`+
                            `<td class="border-right">${formatTeam(input[i].alliances.red.team_keys[2])}</td>`+
                            `<td>${formatTeam(input[i].alliances.blue.team_keys[0])}</td>`+
                            `<td>${formatTeam(input[i].alliances.blue.team_keys[1])}</td>`+
                            `<td>${formatTeam(input[i].alliances.blue.team_keys[2])}</td>`+
                        `</tr>`;
                    }
                }
                return out;
            }

            // Match sorter.
            function sortMatches(input) {
                let out = new Array(input.length);
                for (let i=0; i<input.length; i++) {
                    out[input[i].match_number-1] = input[i];
                }
                return out;
            }

            // Storage.
            if (!localStorage.getItem('lastTeam')) { localStorage.setItem('lastTeam', String(5980)) }
            if (!localStorage.getItem('lastEvent')) { localStorage.setItem('lastEvent', 'misjo') }
            var lastTeam = Number(localStorage.getItem('lastTeam'));
            var lastEvent = localStorage.getItem('lastEvent');

            // URL parameters.
            var urlParams = new URL(window.location.href).searchParams;
            var teamNumber = (urlParams.get('team') == null) ? lastTeam : Number(urlParams.get('team'));
            var eventKey = (urlParams.get('event') == null) ? lastEvent : urlParams.get('event');

            // Autofilling & Restorage.
            $('#team-input').val(teamNumber);
            $('#event-input').val(eventKey);
            $('#team-header').text(teamNumber);
            localStorage.setItem('lastTeam', String(teamNumber));
            localStorage.setItem('lastEvent', eventKey);

            // API config.
            var apiKey = 'dNxAgQWO2qmiRwgMNa8EjbDzbjvRIgv2cJ9yMTpZhIFkNJh7tCBsrOEHNWkZ1TZx';
            var baseUrl = 'https://www.thebluealliance.com/api/v3';
            var teamKey = 'frc' + String(teamNumber);

            // After a delay, gather information.
            setTimeout(function() {

                // Team number.
                $('#event-team').text(teamNumber);

                // Event Information.
                $.getJSON(`${baseUrl}/event/${eventKey}/simple?X-TBA-Auth-Key=${apiKey}`, function(data) {
                    $('#event-name').text(data.name);
                    $('#event-city').text(data.city);
                    $('#event-state').text(data.state_prov);
                    $('#event-start').text(new Date(data.start_date).toLocaleDateString());
                    $('#event-end').text(new Date(data.end_date).toLocaleDateString());
                });

                // Match List.
                $.getJSON(`${baseUrl}/event/${eventKey}/matches/simple?X-TBA-Auth-Key=${apiKey}`, function(data) {

                    // Data structure.
                    let matches = { qm: [], qf: [], sf: [], ff: [] };

                    // Catagorize.
                    for (let i=0; i<data.length; i++) {
                        let type = data[i].comp_level;
                        if (type == 'qm') matches.qm.push(data[i]);
                        if (type == 'qf') matches.qf.push(data[i]);
                        if (type == 'sf') matches.sf.push(data[i]);
                        if (type ==  'f') matches.ff.push(data[i]);
                    }

                    // Sort.
                    matches.qm = sortMatches(matches.qm);
                    matches.qf = sortMatches(matches.qf);
                    matches.sf = sortMatches(matches.sf);
                    matches.ff = sortMatches(matches.ff);

                    // Generate.
                    let output;
                    output += generateMatchItems(matches.qm);
                    output += generateMatchItems(matches.qf);
                    output += generateMatchItems(matches.sf);
                    output += generateMatchItems(matches.ff);

                    // Append.
                    $('#match-list').append(output);

                });

            }, 1000);
            
        </script>

    </body>

</html>